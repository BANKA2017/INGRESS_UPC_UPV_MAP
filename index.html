<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta name="robots" content="nofollow">
        <meta charset="utf-8">
        <link rel="shortcut icon" href="./static/img/favicon.png">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta name="author" content="Banka2017 (https://ingress.ailand.date)">
        <meta name="keywords" content="INGRESS">
        <title>INGRESS UPC/UPV MAP</title>
        <link href="./static/css/bootstrap.min.css" rel="stylesheet preload" as="style">
    </head>
    <body>
        <div id="app">
            <nav class="navbar navbar-expand-lg navbar-light bg-light text-center">
                <span class="navbar-brand mb-0 h1">INGRESS</span>
            </nav>
            <div class="my-4"></div>
            <div class="container">
                <div class="row">
                    <div class="col-md-12">
                        <p class="text-center"><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHJvbGU9ImltZyI+PGNpcmNsZSBjeD0iNSIgY3k9IjUiIHI9IjUiIGZpbGw9InJlZCIgLz48L3N2Zz4=" width="10px" height="10px"> UPC <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHJvbGU9ImltZyI+PGNpcmNsZSBjeD0iNSIgY3k9IjUiIHI9IjUiIGZpbGw9ImdyZWVuIiAvPjwvc3ZnPg==" width="10px" height="10px"> UPV</p>
                        <div class="custom-file">
                            <input type="file" class="custom-file-input" id="gameLog" lang="zh" @change="tsvFileChange">
                            <label class="custom-file-label" for="gameLog">game_log.tsv</label>
                        </div>
                        <div class="my-4"></div>
                        <l-map style="height: 450px; width: 100%" :zoom="zoom" :center="center">
                            <l-tile-layer :url="url" :attribution="attribution"></l-tile-layer>
                            <l-marker v-for="marker in markers" :key="marker.id" :visible="marker.visible" :draggable="marker.draggable" :lat-lng.sync="marker.position" :icon="marker.icon"></l-marker>
                        </l-map>
                        <p class="text-center"><a href="https://github.com/BANKA2017/INGRESS_UPC_UPV_MAP" target="_blank">GitHub</a></p>
                    </div>
                </div>
            </div>
        </div>
        <!--load css and js-->
        <link rel="stylesheet" href="./static/css/noty.css">
        <link rel="stylesheet" href="./static/css/leaflet.css">
        <script src="./static/js/vue.min.js"></script>
        <script src="./static/js/noty.min.js"></script>
        <script src="./static/js/leaflet.js"></script>
        <script src="./static/js/vue2-leaflet.min.js"></script>
        <script>
            'use strict';
            Vue.component('l-map', Vue2Leaflet.LMap);
            Vue.component('l-tile-layer', Vue2Leaflet.LTileLayer);
            Vue.component('l-marker', Vue2Leaflet.LMarker);
            var ingress = new Vue({
                el: "#app",
                data: {
                    url: 'https://a.tile.openstreetmap.org/{z}/{x}/{y}.png',//osm
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                    zoom: 2,
                    center: [0, 0],
                    markers: [],
                },
                methods: {
                    tsvFileChange: function (e) {
                        this.markers = [];
                        let files = e.target.files || e.dataTransfer.files;
                        if(files.length){
                            this.createMap();
                        }else{
                            this.noty('清理完成');
                        }
                    },
                    createMap: function () {
                        let oFReader = new FileReader();
                        let oFile = document.getElementById("gameLog").files[0];
                        if (!/\.tsv$/.test(oFile.name)) { this.noty('请选择文件 <strong>game_log.tsv</strong>', 'error'); return; }
                        this.noty('处理完成');
                        oFReader.readAsText(oFile);
                        oFReader.onload = (e) => {
                            const regex = /\t([0-9\.]+)\t([0-9\.]+)\t(hacked friendly portal|hacked enemy portal|created link|mod deployed|resonator deployed|resonator upgraded|captured portal)/gm;//upc&upv
                            let m;
                            let data = [];
                            while ((m = regex.exec(oFReader.result)) !== null) {
                                if (m.index === regex.lastIndex) {
                                    regex.lastIndex++;
                                }
                                data = data.concat({
                                    upc: m[3] == 'captured portal',
                                    position: { lat: m[1], lng: m[2] },
                                    draggable: false,
                                    visible: true,
                                    icon: this.markerColor(m[3] === 'captured portal' ? 'red' : 'green'),
                                });
                            }
                            this.markers = this.markers.concat(this.unique(data));
                        };
                    },
                    noty: function(text, type='success'){
                        new Noty({
                            timeout: 3000,
                            theme: 'metroui',
                            type: type,
                            text: text,
                        }).show();
                    },
                    unique: function (arr) {
                        let isUPC = false;
                        for(var i=0; i<arr.length; i++){
                            for(var j=i+1; j<arr.length; j++){
                                if(arr[i].position.lat==arr[j].position.lat && arr[i].position.lng==arr[j].position.lng){
                                    if(!arr[j].upc){
                                        arr.splice(j, 1);
                                        j--;
                                    }else{
                                        isUPC = true;
                                    }
                                }
                            }
                            if(isUPC){
                                arr.splice(i, 1);
                                i--;
                                isUPC = !isUPC;
                            }
                        }
                        return arr;
                    },
                    markerColor: function(color, size = 5){
                        return new L.Icon({
                            iconUrl: 'data:image/svg+xml;base64,' + btoa('<svg xmlns="http://www.w3.org/2000/svg" role="img"><circle cx="' + size + '" cy="' + size + '" r="' + size + '" fill="' + color + '" /></svg>'),
                            iconSize: [size * 2, size * 2],
                        })
                    },
                }
            })
        </script>
    </body>
</html>